ukbb_trait_codes = ["20002_1220","20002_1289","20002_1286","20002_1291","20002_1464","20002_1381","20002_1111","22126","20002_1462","K51","20002_1465","20002_1473","K80","20002_1452","20002_1154","D25","6148_2","6148_5","20002_1226","E4_DM1","I42","N80"]

ukbb_trait_pairs = ["20002_1111-22126",
"20002_1220-20002_1465",
"20002_1220-20002_1473",
"20002_1220-K80",
"20002_1111-20002_1465",
"20002_1111-20002_1452",
"20002_1111-20002_1220",
"20002_1286-20002_1465",
"20002_1154-20002_1286",
"20002_1465-20002_1473",
"20002_1286-20002_1291",
"20002_1452-22126",
"20002_1154-20002_1465",
"20002_1226-20002_1473",
"20002_1220-20002_1226",
"20002_1111-20002_1154",
"20002_1464-20002_1465",
"20002_1154-22126",
"20002_1154-20002_1220",
"20002_1226-20002_1465",
"20002_1465-K80",
"20002_1286-K80",
"20002_1473-K80",
"20002_1286-20002_1473",
"20002_1220-20002_1464",
"20002_1226-20002_1286",
"20002_1111-20002_1473",
"20002_1286-22126",
"20002_1462-K51",
"20002_1154-K80",
"20002_1111-20002_1286",
"20002_1465-22126",
"20002_1220-20002_1286",
"20002_1111-K80",
"20002_1154-20002_1226",
"20002_1226-K80",
"20002_1291-20002_1452",
"20002_1154-20002_1473",
"20002_1226-20002_1464",
"20002_1226-D25",
"20002_1462-6148_2",
"20002_1464-20002_1473",
"20002_1111-20002_1464",
"20002_1286-D25",
"20002_1111-20002_1226",
"22126-6148_2",
"20002_1220-6148_2",
"20002_1464-K51",
"6148_2-K51",
"20002_1452-20002_1473",
"20002_1462-20002_1473",
"20002_1291-K51",
"22126-K51",
"20002_1462-22126",
"20002_1464-6148_2",
"20002_1111-20002_1462",
"20002_1464-K80",
"20002_1291-20002_1462",
"20002_1111-D25",
"20002_1452-6148_2",
"20002_1452-20002_1465",
"20002_1154-20002_1452",
"20002_1286-20002_1452",
"20002_1464-22126",
"20002_1465-6148_2",
"20002_1220-20002_1291",
"20002_1291-20002_1473",
"20002_1473-D25",
"20002_1465-D25",
"20002_1286-6148_5",
"20002_1220-K51",
"20002_1291-K80",
"20002_1286-20002_1462",
"20002_1291-6148_2",
"20002_1291-22126",
"20002_1291-20002_1465",
"20002_1452-K80",
"20002_1291-6148_5",
"20002_1462-6148_5",
"20002_1226-K51",
"20002_1111-6148_2",
"20002_1464-D25",
"22126-D25",
"6148_2-D25",
"20002_1473-6148_5",
"20002_1226-20002_1452",
"20002_1220-20002_1462",
"20002_1111-K51",
"20002_1226-6148_5",
"6148_2-6148_5",
"20002_1291-D25",
"20002_1226-20002_1291",
"20002_1286-20002_1464",
"20002_1462-D25",
"20002_1462-K80",
"20002_1111-20002_1291",
"20002_1154-20002_1291",
"6148_5-D25",
"20002_1154-K51",
"20002_1462-20002_1465",
"20002_1452-K51",
"20002_1111-6148_5",
"20002_1452-6148_5",
"20002_1226-6148_2",
"20002_1291-20002_1464",
"6148_2-K80",
"6148_5-K51",
"20002_1154-6148_5",
"20002_1154-D25",
"22126-K80",
"20002_1220-D25",
"20002_1462-20002_1464",
"D25-K80",
"20002_1154-6148_2",
"20002_1220-6148_5",
"D25-K51",
"20002_1220-20002_1452",
"22126-6148_5",
"20002_1464-6148_5",
"20002_1154-20002_1464",
"20002_1473-6148_2",
"20002_1465-K51",
"20002_1452-D25",
"20002_1226-22126",
"20002_1473-22126",
"20002_1226-20002_1462",
"K51-K80",
"20002_1286-6148_2",
"20002_1473-K51",
"6148_5-K80",
"20002_1154-20002_1462",
"20002_1465-6148_5",
"20002_1452-20002_1462",
"20002_1220-22126",
"20002_1286-K51",
"20002_1452-20002_1464",
"20002_1111-20002_1289",
"20002_1111-20002_1381",
"20002_1154-20002_1289",
"20002_1154-20002_1381",
"20002_1220-20002_1289",
"20002_1220-20002_1381",
"20002_1226-20002_1289",
"20002_1226-20002_1381",
"20002_1286-20002_1289",
"20002_1286-20002_1381",
"20002_1289-20002_1291",
"20002_1289-20002_1381",
"20002_1289-20002_1452",
"20002_1289-20002_1462",
"20002_1289-20002_1464",
"20002_1289-20002_1465",
"20002_1289-20002_1473",
"20002_1289-22126",
"20002_1289-6148_2",
"20002_1289-6148_5",
"20002_1289-D25",
"20002_1289-K51",
"20002_1289-K80",
"20002_1291-20002_1381",
"20002_1381-20002_1452",
"20002_1381-20002_1462",
"20002_1381-20002_1464",
"20002_1381-20002_1465",
"20002_1381-20002_1473",
"20002_1381-22126",
"20002_1381-6148_2",
"20002_1381-6148_5",
"20002_1381-D25",
"20002_1381-K51",
"20002_1381-K80",
"20002_1220-E4_DM1",
"20002_1289-E4_DM1",
"20002_1286-E4_DM1",
"20002_1291-E4_DM1",
"20002_1464-E4_DM1",
"20002_1381-E4_DM1",
"20002_1111-E4_DM1",
"22126-E4_DM1",
"20002_1462-E4_DM1",
"K51-E4_DM1",
"20002_1465-E4_DM1",
"20002_1473-E4_DM1",
"K80-E4_DM1",
"20002_1452-E4_DM1",
"20002_1154-E4_DM1",
"D25-E4_DM1",
"6148_2-E4_DM1",
"6148_5-E4_DM1",
"20002_1226-E4_DM1",
"20002_1220-I42",
"20002_1289-I42",
"20002_1286-I42",
"20002_1291-I42",
"20002_1464-I42",
"20002_1381-I42",
"20002_1111-I42",
"22126-I42",
"20002_1462-I42",
"K51-I42",
"20002_1465-I42",
"20002_1473-I42",
"K80-I42",
"20002_1452-I42",
"20002_1154-I42",
"D25-I42",
"6148_2-I42",
"6148_5-I42",
"20002_1226-I42",
"E4_DM1-I42",
"20002_1220-N80",
"20002_1289-N80",
"20002_1286-N80",
"20002_1291-N80",
"20002_1464-N80",
"20002_1381-N80",
"20002_1111-N80",
"22126-N80",
"20002_1462-N80",
"K51-N80",
"20002_1465-N80",
"20002_1473-N80",
"K80-N80",
"20002_1452-N80",
"20002_1154-N80",
"D25-N80",
"6148_2-N80",
"6148_5-N80",
"20002_1226-N80",
"E4_DM1-N80",
"I42-N80"]

pid_ukbb_trait_pairs = ["pid-20002_1220",
"pid-20002_1286",
"pid-20002_1289",
"pid-20002_1291",
"pid-20002_1381",
"pid-20002_1464",
"pid-20002_1111",
"pid-22126",
"pid-20002_1462",
"pid-K51",
"pid-20002_1465",
"pid-20002_1473",
"pid-K80",
"pid-20002_1452",
"pid-20002_1154",
"pid-D25",
"pid-6148_2",
"pid-6148_5",
"pid-20002_1226",
"pid-E4_DM1"]

trait_pairs_for_increasing_perm_fits = ["20002_1220-K80", "20002_1452-22126", "20002_1465-K80",  "20002_1286-D25", "6148_2-K51", "20002_1291-K80"]

rule download_ukbb_sum_stats:
    output:
        "resources/ukbb_sum_stats/{id}.gwas.imputed_v3.both_sexes.tsv.bgz"
    resources:
        runtime = 5
    group: 'ukbb'
    shell:
        """
        wget https://broad-ukb-sumstats-us-east-1.s3.amazonaws.com/round2/additive-tsvs/{wildcards.id}.gwas.imputed_v3.both_sexes.tsv.bgz -O resources/ukbb_sum_stats/{wildcards.id}.gwas.imputed_v3.both_sexes.tsv.bgz
        """

rule decompress_ukbb_sum_stats:
    input:
        "resources/ukbb_sum_stats/{id}.gwas.imputed_v3.both_sexes.tsv.bgz"
    output:
        decomp_file = temp("resources/ukbb_sum_stats/{id}.gwas.imputed_v3.both_sexes.tsv"),
        flag_file = "resources/ukbb_sum_stats/{id}.done"
    resources:
        runtime = 5
    group: 'ukbb'
    shell:
        """
        gunzip -c {input} >{output.decomp_file} && touch {output.flag_file}
        """

rule merge_ukbb_sum_stats:
    input:
        ukbb_files = ["resources/ukbb_sum_stats/%s.gwas.imputed_v3.both_sexes.tsv" % x for x in ukbb_trait_codes]
    output:
        merged_file = "resources/ukbb_sum_stats/{snp_set}/merged_ukbb_sum_stats.tsv.gz"
    params:
        ukbb_trait_codes = ukbb_trait_codes,
        sans_mhc = lambda wildcards: True if wildcards.snp_set == 'sans_mhc' else False
    threads: 12
    resources:
        runtime = 45
    group: 'ukbb'
    script: "../scripts/merge_ukbb_sum_stats.R"

rule make_ukbb_plink_ranges:
    input:
      sum_stats_file = "resources/ukbb_sum_stats/{snp_set}/merged_ukbb_sum_stats.tsv.gz",
      bim_files = [("resources/1000g/euro/qc/chr%d_qc.bim" % x for x in range(1,23)),
      "resources/1000g/euro/qc/chrX_qc.bim"]
    output:
      bim_files = [("resources/plink_ranges/ukbb/{snp_set}/chr%d.txt" % x for x in range(1,23)),
      "resources/plink_ranges/ukbb/{snp_set}/chrX.txt"]
    params:
        sans_mhc = lambda wildcards: True if wildcards.snp_set == 'sans_mhc' else False
    threads: 12
    group: 'ukbb'
    script: "../scripts/make_ukbb_plink_ranges.R"

rule subset_ukbb_snp_variants:
    input:
        "resources/1000g/euro/qc/nodup/{chr}.bed",
        "resources/1000g/euro/qc/nodup/{chr}.bim",
        "resources/1000g/euro/qc/nodup/{chr}.fam",
        range_file = "resources/plink_ranges/ukbb/{snp_set}/{chr}.txt"
    output:
        "resources/ukbb_sum_stats/{snp_set}/nodup/snps_only/{chr}.bed",
        "resources/ukbb_sum_stats/{snp_set}/nodup/snps_only/{chr}.bim",
        "resources/ukbb_sum_stats/{snp_set}/nodup/snps_only/{chr}.fam"
    params:
        input_stem = "resources/1000g/euro/qc/nodup/{chr}",
        output_stem = "resources/ukbb_sum_stats/{snp_set}/nodup/snps_only/{chr}"
    threads: 12
    resources:
        mem_mb=get_mem_mb
    group: 'ukbb'
    shell:
        "plink2 --memory {resources.mem_mb} --threads {threads} --bfile {params.input_stem} --snps-only --make-bed --extract {input.range_file} --silent --out {params.output_stem}"

rule prune_merged_sum_stats:
    input:
      sum_stats_file = "resources/ukbb_sum_stats/{snp_set}/merged_ukbb_sum_stats.tsv.gz",
      bim_file = "resources/plink_subsets/{join}/{snp_set}/all.bim",
      pruned_range_file = "resources/plink_ranges/{join}/{snp_set}/pruned_ranges/window_{window}_step_{step}/all.prune.in"
    output:
        "resources/pruned_sum_stats/{join}/{snp_set}/window_{window}_step_{step}/pruned_merged_sum_stats.tsv"
    params:
        sans_mhc = lambda wildcards: True if wildcards.snp_set == "sans_mhc" else False
    threads: 12
    resources:
        runtime = 30
    group: 'ukbb'
    script: "../scripts/prune_merged_sum_stats.R"

rule downsample_pruned_merged_sum_stats:
    input:
        "resources/pruned_sum_stats/{join}/{snp_set}/window_{window}_step_{step}/pruned_merged_sum_stats.tsv"
    output:
        temp("resources/pruned_sum_stats/{join}/{snp_set}/{no_snps}_snps/window_{window}_step_{step}/pruned_merged_sum_stats.tsv")
    threads: 12
    group: 'ukbb'
    shell:
     "Rscript workflow/scripts/downsample_sum_stats.R -i {input} -n {wildcards.no_snps} -o {output} -nt {threads}"
